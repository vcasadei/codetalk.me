---
title: Compressing <em>Jekyll</em> <br/> generated HTML
---

The *Liquid* syntax used by *Jekyll* has an unpleasant default: it generates significant spaces and unneccessary line breaks in the generated pages source code. This is especially true when you want to indent your *Liquid* code, or want to use loops. Thus, the following source:

```r
{% raw %}
start
{% for i in (1..3) %}
  {% assign foo = i %}
{% endfor %}
end
{% endraw %}
```

... will generate the following code:

```r
start
 
 
 
 
 
 
 
end
```

It is not illogical: *Liquid* reads all the characters in the loop, including spaces and line breaks, and restores them without asking any questions.

To avoid this, the easiest way is to compress the generated source code, by removing all line breaks and all multiple spaces that are not necessary.

For this we have two constraints:

* we musn't compress codes inside `<pre>` tags, in which spaces and lines breaks are important;
* we don't want to use plugins in order to be able to [host our website on *GitHub Pages*]({{site.base}}/using-github-to-serve-jekyll/).

The method explained in this article is freely inspired by [`jekyll-compress-html`](https://github.com/penibelst/jekyll-compress-html), created by [Anatol Broder](https://github.com/penibelst).

## Using a layout

We wish to directly modify the source code of each page generated by Jekyll through *Liquid*.

To do this, the easiest way is to create a file `compress.html` in the `layout` folder and then to add a reference to `compress.html` into the frontmatter of the file(s) used to generate the various pages of your site:

```r
---
layout: compress
--- 
<html>
...
</html>
```

In our file `compress.html`, we can modify all of the source code generated through the variable `content`. For example, if you want to change all the "a" with "b", you just have to provide:

```r
{% raw %}
{{ content | replace: "a", "b" }}
{% endraw %}
```


## Code blocks detection
The `split` filter can cut a string around a specific substring. For example, the following source code will generate an array of variables, each of which will contain what is present between two `<pre>`:

```r
{% raw %}
{% assign var = content | split: '<pre>' %}
{% endraw %}
```

It will thus be possible for us, using a loop, apply some filters only for blocks of code, and others in the rest of the page only. Thus, we can apply filters to the entire code of a page without having any influence on the code blocks[[to do this, we first get all the content around `<pre>` and then we split these into two parts, in order to separate content around the `</pre>` closing tag]] by putting in `compress.html`:

```r
{% raw %}
{% assign temp1 = content | split: '<pre>' %}
{% for temp2 in temp1 %}
{% assign temp3 = temp2 | split: '</pre>' %}
{% if temp3.size == 2 %}
<pre>{{ temp3.first }}</pre>
{% endif %}
{{ temp3.last }}
{% endfor %}
{% endraw %}
```

We can then, based on this, either only apply filters to code blocks[[by adding a filter to `{%raw%}{{temp3.first}}{%endraw%}`]], for example [adding `<code>` tags on each line in order to numerate them]({{site.base}}/using-css-to-add-line-numbering/), or otherwise the rest of the source code of the site[[by modifying `{%raw%}{{temp3.last}}{%endraw%}`]], for instance in order to improve typography.

## Compressing HTML code

Now, we just have to compress the HTML code. In the code blocks, we will transform new lines in `<br/>` in order to preserve line breaks with the `newline_to_br` filter. We will remove all multiple spaces and line breaks for the rest of the code. For this, we will use `split` on each spaces, then `join`. 

With the previous code, we get:

```r
{% raw %}
{% assign temp1 = content | split: '<pre>' %}
{% for temp2 in temp1 %}
{% assign temp3 = temp2 | split: '</pre>' %}
{% if temp3.size == 2 %}
<pre>{{ temp3.first | newline_to_br }}</pre>
{% endif %}
{{ temp3.last | split: ' ' | join: ' ' }}
{% endfor %}
{% endraw %}
```

Finally, we remove all the line breaks by using a `capture` then the `strip_newline` filter:

```r
{% raw %}
{% capture compress %}
{% assign temp1 = content | split: '<pre>' %}
{% for temp2 in temp1 %}
{% assign temp3 = temp2 | split: '</pre>' %}
{% if temp3.size == 2 %}
    <pre>{{ temp3.first | newline_to_br }}</pre>
{% endif %}
{{ temp3.last | split: ' ' | join: ' ' }}
{% endfor %}
{% endcapture %}{{ compress | strip_newlines }}
{% endraw %}
```

That's it! You can see that it remains only one line of code, outside the `<pre>` code blocks where nothing has been changed.
